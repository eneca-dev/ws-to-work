# –§–∞–∑–∞ 1: –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

## –û–±–∑–æ—Ä

–≠—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏—è –¥–æ–±–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–≥—É—é –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –¥—É–±–ª–µ–π –ø—Ä–æ–µ–∫—Ç–æ–≤, —Å—Ç–∞–¥–∏–π, –æ–±—ä–µ–∫—Ç–æ–≤ –∏ —Ä–∞–∑–¥–µ–ª–æ–≤.

## –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

### 1. –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã
- **`utils/validator.js`** - –º–æ–¥—É–ª—å –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- **`database/phase1-deduplication.sql`** - SQL –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –ë–î
- **`database/README-DEDUPLICATION.md`** - —ç—Ç–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
- **`services/supabase.js`** - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤–æ –≤—Å–µ –º–µ—Ç–æ–¥—ã create/update/upsert
  - –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ content_hash –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
  - –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ duplicate key errors (23505)
  - –ü—Ä–æ–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å

### 3. –û—Å–Ω–æ–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

#### ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
- Sanitization —Å—Ç—Ä–æ–∫ (trim, —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–≤–∏–¥–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤)
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã –ø–æ–ª–µ–π
- –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ external_id –∏ external_source –Ω–µ –ø—É—Å—Ç—ã–µ

#### ‚úÖ Content Hash
- –í—ã—á–∏—Å–ª–µ–Ω–∏–µ MD5 —Ö—ç—à–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –∑–∞–ø–∏—Å–∏
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ö—ç—à–µ–π –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –ü—Ä–æ–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã (—ç–∫–æ–Ω–æ–º–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤)

#### ‚úÖ –°—Ç—Ä–æ–≥–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
- Unique constraints –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
- –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–ª—é—á–µ–π –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- Graceful handling –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –¥—É–±–ª–µ–π

---

## üìã –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏

### –®–∞–≥ 1: –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–î

**–í–ê–ñ–ù–û!** –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–π—Ç–µ backup –ë–î.

1. –ó–∞–π–¥–∏—Ç–µ –≤ Supabase Dashboard ‚Üí Database ‚Üí Backups
2. –ù–∞–∂–º–∏—Ç–µ "Create backup" –∏–ª–∏ —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ backups –≤–∫–ª—é—á–µ–Ω—ã
3. –ó–∞–ø–∏—à–∏—Ç–µ –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è backup

### –®–∞–≥ 2: –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è

–û—Ç–∫—Ä–æ–π—Ç–µ Supabase SQL Editor –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å—ã –∏–∑ **–ß–ê–°–¢–ò 1** —Ñ–∞–π–ª–∞ `phase1-deduplication.sql`:

```sql
-- 1.1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–µ–π –≤ projects
SELECT
    external_id,
    external_source,
    COUNT(*) as duplicate_count,
    array_agg(project_id) as project_ids,
    array_agg(project_name) as project_names
FROM projects
WHERE external_id IS NOT NULL
GROUP BY external_id, external_source
HAVING COUNT(*) > 1
ORDER BY duplicate_count DESC;
```

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ 4 –∑–∞–ø—Ä–æ—Å–∞ (–¥–ª—è projects, stages, objects, sections).

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ï—Å–ª–∏ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –≤–µ—Ä–Ω—É–ª–∏ 0 —Å—Ç—Ä–æ–∫ - –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ —Å—Ä–∞–∑—É –∫ **–®–∞–≥—É 4**
- ‚ö†Ô∏è  –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã –¥—É–±–ª–∏ - –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ **–®–∞–≥—É 3**

### –®–∞–≥ 3: Cleanup –¥—É–±–ª–µ–π (–µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã)

‚ö†Ô∏è **–í–ù–ò–ú–ê–ù–ò–ï!** –≠—Ç–∏ –∑–∞–ø—Ä–æ—Å—ã —É–¥–∞–ª—è—é—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î!

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å—ã –∏–∑ **–ß–ê–°–¢–ò 2** —Ñ–∞–π–ª–∞ `phase1-deduplication.sql` **–°–¢–†–û–ì–û –ü–û –ü–û–†–Ø–î–ö–£**:

1. –°–Ω–∞—á–∞–ª–∞ `sections` (–¥–æ—á–µ—Ä–Ω—è—è —Ç–∞–±–ª–∏—Ü–∞)
2. –ó–∞—Ç–µ–º `objects`
3. –ó–∞—Ç–µ–º `stages`
4. –ü–æ—Å–ª–µ–¥–Ω–∏–º `projects` (—Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è —Ç–∞–±–ª–∏—Ü–∞)

–ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: `"duplicates removed: 0"`

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è —É–¥–∞–ª–µ–Ω–∏—è:**
- –û—Å—Ç–∞–≤–ª—è–µ–º —Å–∞–º—É—é —Å–≤–µ–∂—É—é –∑–∞–ø–∏—Å—å (–ø–æ `external_updated_at` –∏–ª–∏ `created_at`)
- –ï—Å–ª–∏ –¥–∞—Ç—ã –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ - –æ—Å—Ç–∞–≤–ª—è–µ–º —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º ID
- –û—Å—Ç–∞–ª—å–Ω—ã–µ –¥—É–±–ª–∏ —É–¥–∞–ª—è—é—Ç—Å—è

### –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ Unique Constraints

–í—ã–ø–æ–ª–Ω–∏—Ç–µ **–ß–ê–°–¢–¨ 3** –∏–∑ `phase1-deduplication.sql`:

```sql
-- 3.1. Unique constraint –¥–ª—è projects
ALTER TABLE projects
ADD CONSTRAINT projects_external_unique
UNIQUE (external_id, external_source);
```

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ 4 constraint'–∞. –ö–∞–∂–¥—ã–π –¥–æ–ª–∂–µ–Ω –≤—ã–≤–µ—Å—Ç–∏:
```
Created constraint: [–∏–º—è_constraint]
```

–ò–ª–∏ –µ—Å–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:
```
Constraint already exists: [–∏–º—è_constraint]
```

**–ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –æ—à–∏–±–∫—É `duplicate key`:**
1. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –∫ **–®–∞–≥—É 2** - –Ω–∞–π–¥–∏—Ç–µ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –¥—É–±–ª–∏
2. –£–¥–∞–ª–∏—Ç–µ –∏—Ö –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ **–®–∞–≥ 3**
3. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É —Å–æ–∑–¥–∞–Ω–∏—è constraint

### –®–∞–≥ 5: –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤

–í—ã–ø–æ–ª–Ω–∏—Ç–µ **–ß–ê–°–¢–¨ 4** –∏–∑ `phase1-deduplication.sql`.

–≠—Ç–∏ –∏–Ω–¥–µ–∫—Å—ã —É—Å–∫–æ—Ä—è—é—Ç:
- –ü–æ–∏—Å–∫ –ø–æ external_id –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ email
- Joins –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏

–í—Å–µ –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —Å `IF NOT EXISTS`, –ø–æ—ç—Ç–æ–º—É –±–µ–∑–æ–ø–∞—Å–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ.

### –®–∞–≥ 6: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ constraints

–í—ã–ø–æ–ª–Ω–∏—Ç–µ **–ß–ê–°–¢–¨ 5** –∏–∑ `phase1-deduplication.sql`.

–≠—Ç–∏ constraints –ø—Ä–æ–≤–µ—Ä—è—é—Ç —á—Ç–æ:
- `external_id` –Ω–µ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
- `external_source` –Ω–µ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞

### –®–∞–≥ 7: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å—ã –∏–∑ **–ß–ê–°–¢–ò 6** –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```sql
-- 6.1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ constraints —Å–æ–∑–¥–∞–Ω—ã
SELECT
    conname as constraint_name,
    conrelid::regclass as table_name,
    pg_get_constraintdef(oid) as definition
FROM pg_constraint
WHERE conname IN (
    'projects_external_unique',
    'stages_project_external_unique',
    'objects_stage_external_unique',
    'sections_project_external_unique'
)
ORDER BY table_name;
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** 4 —Å—Ç—Ä–æ–∫–∏ —Å constraints

```sql
-- 6.3. –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–µ–π (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 0 –≤–µ–∑–¥–µ)
SELECT 'Projects' as table_name, COUNT(*) as duplicates_found FROM ...
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
Projects  | 0
Stages    | 0
Objects   | 0
Sections  | 0
```

### –®–∞–≥ 8: –î–µ–ø–ª–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î, –¥–µ–ø–ª–æ–π—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:

```bash
cd ws-to-work
git add .
git commit -m "Phase 1: Add strict data deduplication"
git push heroku main
```

–ò–ª–∏ –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ GitHub + Heroku auto-deploy:
```bash
git push origin main
```

### –®–∞–≥ 9: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é:
```bash
curl -X POST https://your-app.herokuapp.com/api/sync
```

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
```bash
heroku logs --tail
```

3. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:
   - ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —É—Å–ø–µ—à–Ω–æ
   - ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ `duplicate key violation`
   - ‚úÖ –í–∏–¥–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è –æ validation
   - ‚úÖ –í–∏–¥–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è `unchanged, skipping update` –¥–ª—è –Ω–µ–∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π

---

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

### –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ

–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã –¥–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å –≤ –ª–æ–≥–∞—Ö:

```
‚úÖ Stage "–°—Ç–∞–¥–∏—è 1" unchanged, skipping update
‚úÖ Object "–û–±—ä–µ–∫—Ç 1" unchanged, skipping update
‚úÖ Section "–†–∞–∑–¥–µ–ª 1" unchanged, skipping update
```

–≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ! –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ content hash —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –¥–µ–ª–∞–µ—Ç –ª–∏—à–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–µ–π

–ó–∞–ø—É—Å–∫–∞–π—Ç–µ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏:

```sql
-- –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏
SELECT 'Projects' as table_name, COUNT(*) as duplicates FROM (
    SELECT external_id, external_source, COUNT(*) as cnt
    FROM projects WHERE external_id IS NOT NULL
    GROUP BY external_id, external_source HAVING COUNT(*) > 1
) t
UNION ALL
SELECT 'Stages', COUNT(*) FROM (
    SELECT stage_project_id, external_id, external_source, COUNT(*) as cnt
    FROM stages WHERE external_id IS NOT NULL
    GROUP BY stage_project_id, external_id, external_source HAVING COUNT(*) > 1
) t
UNION ALL
SELECT 'Objects', COUNT(*) FROM (
    SELECT object_stage_id, external_id, external_source, COUNT(*) as cnt
    FROM objects WHERE external_id IS NOT NULL
    GROUP BY object_stage_id, external_id, external_source HAVING COUNT(*) > 1
) t
UNION ALL
SELECT 'Sections', COUNT(*) FROM (
    SELECT section_project_id, external_id, external_source, COUNT(*) as cnt
    FROM sections WHERE external_id IS NOT NULL
    GROUP BY section_project_id, external_id, external_source HAVING COUNT(*) > 1
) t;
```

**–í—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å 0!**

---

## üö® Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ `duplicate key violation` –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

**–ü—Ä–∏—á–∏–Ω–∞:** –û—Å—Ç–∞–ª–∏—Å—å –¥—É–±–ª–∏ –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã

**–†–µ—à–µ–Ω–∏–µ:**
1. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –∫ **–®–∞–≥—É 2** - –Ω–∞–π–¥–∏—Ç–µ –¥—É–±–ª–∏
2. –£–¥–∞–ª–∏—Ç–µ –∏—Ö –≤—Ä—É—á–Ω—É—é
3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ `validation failed` –≤ –ª–æ–≥–∞—Ö

**–ü—Ä–∏—á–∏–Ω–∞:** –î–∞–Ω–Ω—ã–µ –∏–∑ Worksection –Ω–µ –ø—Ä–æ—Ö–æ–¥—è—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥ –Ω–∞ –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏
2. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ Worksection (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—É—Å—Ç—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è)
3. –ò–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Å–ª–∞–±—å—Ç–µ –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤ `utils/validator.js`

### –ü—Ä–æ–±–ª–µ–º–∞: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å—Ç–∞–ª–∞ –º–µ–¥–ª–µ–Ω–Ω–µ–µ

**–ü—Ä–∏—á–∏–Ω–∞:** –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ! –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ö—ç—à–µ–π –¥–æ–±–∞–≤–ª—è—é—Ç –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–µ—Ä–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –±—É–¥–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–µ–µ (–≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ö—ç—à–µ–π)
- –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –±—É–¥—É—Ç –±—ã—Å—Ç—Ä–µ–µ –±–ª–∞–≥–æ–¥–∞—Ä—è –ø—Ä–æ–ø—É—Å–∫—É –Ω–µ–∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
- –ï—Å–ª–∏ –∫—Ä–∏—Ç–∏—á–Ω–æ - –º–æ–∂–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å content_hash –ø—Ä–æ–≤–µ—Ä–∫–∏

### –ü—Ä–æ–±–ª–µ–º–∞: Content hash –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–∏—á–∏–Ω–∞:** –í–æ–∑–º–æ–∂–Ω–æ –≤ –ë–î –Ω–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ `content_hash`

**–†–µ—à–µ–Ω–∏–µ:**
```sql
-- –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É content_hash –≤ —Ç–∞–±–ª–∏—Ü—ã (–µ—Å–ª–∏ –Ω–µ—Ç)
ALTER TABLE projects ADD COLUMN IF NOT EXISTS content_hash VARCHAR(32);
ALTER TABLE stages ADD COLUMN IF NOT EXISTS content_hash VARCHAR(32);
ALTER TABLE objects ADD COLUMN IF NOT EXISTS content_hash VARCHAR(32);
ALTER TABLE sections ADD COLUMN IF NOT EXISTS content_hash VARCHAR(32);
```

---

## üîô Rollback (–æ—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π)

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –º–æ–∂–Ω–æ –æ—Ç–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è:

### –û—Ç–∫–∞—Ç –ë–î

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—ã –∏–∑ **–ß–ê–°–¢–ò 7** —Ñ–∞–π–ª–∞ `phase1-deduplication.sql`:

```sql
-- –£–¥–∞–ª–µ–Ω–∏–µ constraints
ALTER TABLE projects DROP CONSTRAINT IF EXISTS projects_external_unique;
ALTER TABLE stages DROP CONSTRAINT IF EXISTS stages_project_external_unique;
ALTER TABLE objects DROP CONSTRAINT IF EXISTS objects_stage_external_unique;
ALTER TABLE sections DROP CONSTRAINT IF EXISTS sections_project_external_unique;

-- –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤
DROP INDEX IF EXISTS idx_projects_external_id;
DROP INDEX IF EXISTS idx_projects_external_source;
-- ... –∏ —Ç.–¥.
```

### –û—Ç–∫–∞—Ç –∫–æ–¥–∞

```bash
git revert HEAD
git push heroku main
```

–ò–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–º–º–∏—Ç–∞.

---

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

‚úÖ **–ù–µ—Ç –¥—É–±–ª–µ–π** - —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ constraints –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –¥—É–±–ª–µ–π –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î

‚úÖ **–ú–µ–Ω—å—à–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π** - content hash –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –Ω–µ–∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏

‚úÖ **–í–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** - –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é

‚úÖ **–õ—É—á—à–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –∏–Ω–¥–µ–∫—Å—ã —É—Å–∫–æ—Ä—è—é—Ç –ø–æ–∏—Å–∫

‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - graceful handling –æ—à–∏–±–æ–∫ –¥—É–±–ª–µ–π

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –§–∞–∑—ã 1, –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫:

- **–§–∞–∑–∞ 2**: –£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ (retry logic, timeouts)
- **–§–∞–∑–∞ 3**: Telegram –±–æ—Ç –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤
- **–§–∞–∑–∞ 4**: Heroku Scheduler –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞
- **–§–∞–∑–∞ 5**: –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –º–µ—Ç—Ä–∏–∫–∏

---

## ‚ùì –í–æ–ø—Ä–æ—Å—ã –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `heroku logs --tail`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Supabase Dashboard ‚Üí Database ‚Üí Logs
3. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—Å–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã –ø–æ –ø–æ—Ä—è–¥–∫—É
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ backup –ë–î —Å–æ–∑–¥–∞–Ω

–í —Å–ª—É—á–∞–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º - –≤—ã–ø–æ–ª–Ω–∏—Ç–µ rollback –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏–∑ backup.
