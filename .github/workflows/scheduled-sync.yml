name: Scheduled Sync

on:
  # –ó–∞–ø—É—Å–∫ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –∫–∞–∂–¥—ã–µ 3 —á–∞—Å–∞
  schedule:
    - cron: '0 0,3,6,9,12,15,18,21 * * *'  # –í 00:00, 03:00, 06:00, 09:00, 12:00, 15:00, 18:00, 21:00 UTC

  # –¢–∞–∫–∂–µ —Ä–∞–∑—Ä–µ—à–∞–µ–º —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ GitHub
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Sync
        run: |
          echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤ $(date)"

          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –æ—Ç—á–µ—Ç–æ–≤ (daily –≤ 9:00 UTC)
          HOUR=$(date -u +%H)
          if [ "$HOUR" = "09" ]; then
            COSTS_MODE="daily"
          else
            COSTS_MODE="skip"
          fi

          echo "üí∞ Costs mode: $COSTS_MODE"

          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST –∑–∞–ø—Ä–æ—Å –∫ –≤–∞—à–µ–º—É API
          response=$(curl -X POST "${{ secrets.APP_URL }}/api/sync" \
            -H "Content-Type: application/json" \
            -d "{\"offset\": 0, \"limit\": 999, \"costs_mode\": \"$COSTS_MODE\"}" \
            -w "\n%{http_code}" \
            -s)

          # –ü–æ–ª—É—á–∞–µ–º HTTP –∫–æ–¥ –æ—Ç–≤–µ—Ç–∞
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "üìä HTTP –∫–æ–¥: $http_code"

          if [ "$http_code" = "200" ]; then
            echo "‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
            echo "$body" | jq '.stats' || echo "$body"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏"
            echo "$body"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          echo "‚è∞ –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: $(date)"
          echo "üåç Timezone: UTC"
