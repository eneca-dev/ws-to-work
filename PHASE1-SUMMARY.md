# ‚úÖ –§–∞–∑–∞ 1: –°—Ç—Ä–æ–≥–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è - –ó–ê–í–ï–†–®–ï–ù–ê

## üì¶ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. SQL –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –ë–î
**–§–∞–π–ª:** `database/phase1-deduplication.sql`

- ‚úÖ –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–∏—Ö –¥—É–±–ª–µ–π (–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–∏—Å–∫–∞)
- ‚úÖ Cleanup —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –¥—É–±–ª–µ–π
- ‚úÖ Unique constraints –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–µ–π:
  - `projects_external_unique` –Ω–∞ `(external_id, external_source)`
  - `stages_project_external_unique` –Ω–∞ `(stage_project_id, external_id, external_source)`
  - `objects_stage_external_unique` –Ω–∞ `(object_stage_id, external_id, external_source)`
  - `sections_project_external_unique` –Ω–∞ `(section_project_id, external_id, external_source)`
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ constraints (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫)
- ‚úÖ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ rollback —Å–∫—Ä–∏–ø—Ç—ã

### 2. –ú–æ–¥—É–ª—å –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö
**–§–∞–π–ª:** `utils/validator.js`

- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è: projects, stages, objects, sections
- ‚úÖ Sanitization —Å—Ç—Ä–æ–∫ (trim, —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–≤–∏–¥–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞—Ç
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
- ‚úÖ Content hash –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π (MD5)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–ª—é—á–µ–π –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π Supabase —Å–µ—Ä–≤–∏—Å
**–§–∞–π–ª:** `services/supabase.js`

- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤–æ –≤—Å–µ –º–µ—Ç–æ–¥—ã create/update
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã upsert –º–µ—Ç–æ–¥—ã:
  - `upsertStageByKey()` - —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∏ content hash
  - `upsertObjectByKey()` - —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∏ content hash
  - `upsertSectionByKey()` - —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∏ content hash
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ content_hash –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
- ‚úÖ –ü—Ä–æ–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
- ‚úÖ –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ duplicate key errors (23505)
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏

### 4. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
**–§–∞–π–ª:** `database/README-DEDUPLICATION.md`

- ‚úÖ –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
- ‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
- ‚úÖ Troubleshooting –∏ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º
- ‚úÖ Rollback –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

---

## üéØ –ß—Ç–æ —ç—Ç–æ –¥–∞–µ—Ç

### –î–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏:
- ‚úÖ **100% –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π** –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
- ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö** –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é
- ‚úÖ **Graceful handling** –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

### –î–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:
- ‚úÖ **–ü—Ä–æ–ø—É—Å–∫ –ª–∏—à–Ω–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π** —á–µ—Ä–µ–∑ content hash
- ‚úÖ **–ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫** —á–µ—Ä–µ–∑ –∏–Ω–¥–µ–∫—Å—ã
- ‚úÖ **–ú–µ–Ω—å—à–µ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î**

### –î–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏:
- ‚úÖ **–î–∞–Ω–Ω—ã–µ –≤—Å–µ–≥–¥–∞ –≤–∞–ª–∏–¥–Ω—ã**
- ‚úÖ **–ù–µ—Ç –ø—É—Å—Ç—ã—Ö —Å—Ç—Ä–æ–∫** –≤ external_id/external_source
- ‚úÖ **–ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** (trim, –¥–ª–∏–Ω–∞)

---

## üìù –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å SQL –º–∏–≥—Ä–∞—Ü–∏–∏
```bash
# –û—Ç–∫—Ä–æ–π—Ç–µ Supabase SQL Editor
# –í—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ –ø–æ—Ä—è–¥–∫—É:
# 1. –ß–ê–°–¢–¨ 1: –ê–Ω–∞–ª–∏–∑ –¥—É–±–ª–µ–π
# 2. –ß–ê–°–¢–¨ 2: Cleanup (–µ—Å–ª–∏ –µ—Å—Ç—å –¥—É–±–ª–∏)
# 3. –ß–ê–°–¢–¨ 3: Unique constraints
# 4. –ß–ê–°–¢–¨ 4: –ò–Ω–¥–µ–∫—Å—ã
# 5. –ß–ê–°–¢–¨ 5: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ constraints
# 6. –ß–ê–°–¢–¨ 6: –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
```

### 2. –î–µ–ø–ª–æ–π –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
```bash
cd ws-to-work
git add .
git commit -m "Phase 1: Add strict data deduplication

- Add database unique constraints for deduplication
- Add data validation module (utils/validator.js)
- Update Supabase service with validation and content hash
- Add comprehensive migration documentation"

git push origin main
# –∏–ª–∏
git push heroku main
```

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
curl -X POST https://your-app.herokuapp.com/api/sync

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
heroku logs --tail

# –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ:
# ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞
# ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ duplicate key
# ‚úÖ –í–∏–¥–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è validation
# ‚úÖ –í–∏–¥–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è "unchanged, skipping update"
```

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤

```
ws-to-work/
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ phase1-deduplication.sql         # SQL –º–∏–≥—Ä–∞—Ü–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ README-DEDUPLICATION.md          # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ validator.js                     # –ù–æ–≤—ã–π: –ú–æ–¥—É–ª—å –≤–∞–ª–∏–¥–∞—Ü–∏–∏
‚îÇ   ‚îî‚îÄ‚îÄ logger.js                        # –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ supabase.js                      # –û–±–Ω–æ–≤–ª–µ–Ω: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ worksection.js                   # –ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
‚îî‚îÄ‚îÄ PHASE1-SUMMARY.md                    # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

---

## üîç –ü—Ä–∏–º–µ—Ä—ã —É–ª—É—á—à–µ–Ω–∏–π

### –î–æ:
```javascript
// –ú–æ–≥–ª–∏ —Å–æ–∑–¥–∞—Ç—å—Å—è –¥—É–±–ª–∏
await supabase.createProject({
  project_name: "  Test Project  ", // –ø—Ä–æ–±–µ–ª—ã
  external_id: "123",
  external_source: "worksection"
});

await supabase.createProject({
  project_name: "Test Project",
  external_id: "123", // –î–£–ë–õ–¨!
  external_source: "worksection"
});
```

### –ü–æ—Å–ª–µ:
```javascript
// 1. –î–∞–Ω–Ω—ã–µ –Ω–æ—Ä–º–∞–ª–∏–∑—É—é—Ç—Å—è
const validation = validator.validateProject({
  project_name: "  Test Project  "
});
// ‚Üí project_name: "Test Project" (trim)

// 2. –î—É–±–ª–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
// Constraint: projects_external_unique (external_id, external_source)

// 3. –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è
// Content hash –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å
// ‚Üí "Project unchanged, skipping update"
```

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è –§–∞–∑—ã 1, –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫:

### –§–∞–∑–∞ 2: –£–ª—É—á—à–µ–Ω–∏–µ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
- Retry –º–µ—Ö–∞–Ω–∏–∑–º —Å exponential backoff
- Graceful error handling
- Timeout –∏ rate limiting
- Circuit breaker

### –§–∞–∑–∞ 3: Telegram –±–æ—Ç
- –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –ö–æ–º–∞–Ω–¥—ã: /status, /last_sync, /logs
- –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤

### –§–∞–∑–∞ 4: Heroku Scheduler
- CLI –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Heroku Scheduler addon
- –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —Ä–∞–∑ –≤ –¥–µ–Ω—å
- –û—Ç—á–µ—Ç –≤ Telegram –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

### –§–∞–∑–∞ 5: –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ (JSON)
- –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–æ–≤ (DEBUG, INFO, WARNING, ERROR)
- –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–≥–æ–≤
- –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

## ‚úÖ Checklist –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º

- [ ] –°–æ–∑–¥–∞–Ω backup –ë–î –≤ Supabase
- [ ] –í—ã–ø–æ–ª–Ω–µ–Ω—ã –≤—Å–µ SQL –º–∏–≥—Ä–∞—Ü–∏–∏ (–ß–ê–°–¢–ò 1-6)
- [ ] –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∫–∞–∑–∞–ª–∞ 0 –¥—É–±–ª–µ–π
- [ ] –í—Å–µ constraints —Å–æ–∑–¥–∞–Ω—ã (4 —à—Ç)
- [ ] –í—Å–µ –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã
- [ ] –ö–æ–¥ –∑–∞–∫–æ–º–º–∏—á–µ–Ω –≤ git
- [ ] –î–µ–ø–ª–æ–π –Ω–∞ Heroku/production –≤—ã–ø–æ–ª–Ω–µ–Ω
- [ ] –¢–µ—Å—Ç–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ
- [ ] –õ–æ–≥–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –Ω–∞ –æ—à–∏–±–∫–∏
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞—Å—Ç—Ä–æ–µ–Ω

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `database/README-DEDUPLICATION.md` ‚Üí —Ä–∞–∑–¥–µ–ª Troubleshooting
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `heroku logs --tail`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Supabase Dashboard ‚Üí Database ‚Üí Logs
4. –í –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–ª—É—á–∞—è—Ö –≤—ã–ø–æ–ª–Ω–∏—Ç–µ rollback (–ß–ê–°–¢–¨ 7 SQL —Ñ–∞–π–ª–∞)

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–û–¢–û–í–û –ö –î–ï–ü–õ–û–Æ

**–î–∞—Ç–∞:** 2025-11-05

**–ê–≤—Ç–æ—Ä:** Claude Code Assistant
